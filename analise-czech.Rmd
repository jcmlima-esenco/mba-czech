---
title: "Analise Czech"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

# Objetivo ################################

Um banco quer melhor os seus servicos.

Como exemplo, os gerentes tem apenas uma idéia vaga, de quem é um bom cliente e de quem é o mal cliente.

Os gerentes não possuem nenhum pergunta especifica, então a análise ocorrera com enfoque na exploração, tentando responder algumas hipotéticas questões 

- O que, dentro das característoas de um emprestimo, influencia a inadimplencia de um cliente
- A quem deve-se ofertar/reduzir o cartão de acordo com o com região / crédito / perfil do cliente.
- ofertar/reduzir crédito de acordo com região / crédito / perfil do cliente
- marketing para abrir contas em determinada região.

## Analise de inadimplencia do cliente

Um bom cliente, iremos definir que é o cliente que realizar emprestimos e paga os mesmos. Cliente adimplente.
Um mal cliente, iremos definir que é o cliente que realizar emprestimos e não paga os mesmos. Cliente inadimplente.

As situações de um emprestimo podem ser:

'A' Contrato de emprestimo finalizado sem problema.
'B' Contrato de emprestimo finalizado, porém o emprestimo não foi pago.
'C' Contrato de emprestimo em andamento, com pagamentos em dia.
'D' Contrato de emprestimo em andamento, com pagamentos em atraso.

A pergunta que se quer responder é:
Dado um cliente, qual a probabilidade de quando o emprestimo for finalizado, ele se tornar inadimplente ou ter contrato default?

*Podemos também determinar quem é um bom cliente por outros prismas, mas para esta análise iremos focar na relação de cliente e emprestimos.*

# Leitura de dados

O banco possue dados históricos, de transações, emprestimos, geolocalizacao, uso do cartão e outros. Os dados foram limpos e encontram-se em uma base MySQL

Para mais informações sobre o modelo de dados, vide documento **PKDD'99 Discovery Challenge Guide to the Financial Data Set**

Estes dados serão utilizados para a modelagem do problema e construção de um modelo preditivo

```{r echo = FALSE}
# Libraries
library(RMySQL)
library(ggplot2)
library(dplyr)

#database connection
con <- dbConnect(MySQL(), user='czech', password='czech123', dbname='czech', host='czech-mysql.ctidba6hrq5v.us-east-1.rds.amazonaws.com')

# principais tabelas
client <- dbReadTable(con, "client")
account <- dbReadTable(con, "account")
disp <- dbReadTable(con, "disposition")
account_disp <- merge(account, disp, by="account_id")
account_client <- merge(account_disp, client, by = "client_id")
demograph <- dbReadTable(con, "demograph")
```

# Análise Exploratória

Os empréstimos, possuem a distribuição a seguir:

```{r}
loan <- dbReadTable(con, "loan")
loan <- loan %>% mutate(inadimplentes = (status == "B" | status == "D"))
loan %>% ggplot(aes(x=inadimplentes)) + geom_bar() 
```

# Correlações, apenas utilizando variáveis de empréstimo.

## Montante do empréstimo influência?

H0 : O montante do empréstimo não influencia a inadimplência
HA : O montante do empréstimo influencia a inadimplência

```{r}
model_amount <- glm(inadimplentes ~ amount, data = loan)
summary(model_amount)
melhor_modelo <- model_amount
```

Logo, podemos ver que o valor do emprestimo influencia a probabilidade de inadimplencia (p-value = 0,000355) - existe uma forte corelação entre o amount e a adimplencia.

## A duraçãoo dos emprestimos

- H0 : A duração dos empréstimos não influência a inadimplencia
- HA : A duração dos empréstimos influência a inadimplencia

```{r}
model_duration <- glm(inadimplentes ~ durantion, data = loan)
summary(model_duration)
```
Podemos visualizar que a duração não influencia ( p-value = 0.146 )

## E ambos juntos?

```{r}
novo_modelo <- glm(inadimplentes ~ durantion + amount, data = loan)
summary(novo_modelo)
melhor_modelo <- novo_modelo
```

O valor e a duração juntos influenciam a inadimplencia!

## O valor das parcelas influenciam?

H0 : O valor das parcelas não influência a inadimplencia
HA : O valor das parcelas influência a inadimplencia 

```{r}
novo_modelo <- glm(inadimplentes ~ payments, data = loan)
summary(novo_modelo)
```

O valor da parcela influencia a inadimplencia!

Mas devemos incluir a valor no modelo candidato ? 
```{r}
novo_modelo <- glm(inadimplentes ~ amount + durantion + payments, data = loan)
summary(novo_modelo)
```

Neste modelo, todos os p-values são maiores que 0,05, assim, optamos por não utilizar o valor da prestacao.

## O Sexo do cliente influencia na inadimplencia?

- H0 : O sexo do cliente não influência a inadimplencia
- HA : O sexo do cliente influência a inadimplencia 

O sexo entre os clientes se distribui como

```{r}
account_client %>% ggplot(aes(x=sex)) + geom_bar() 
```

Logo, temos uma distribuição quase equilibrado entre ambos os sexos, mas em relacão a inadimplencia, como se comportam ambos os sexos?

```{r}
account_loan <- account_client %>% merge(loan, by = "account_id")
novo_modelo <- glm(inadimplentes ~ sex , data = account_loan)
summary(novo_modelo)
```

Podemos verificar que o sexo do cliente não possui relação (alto p-value) com a inadimplencia ou não do mesmo.

## Região geográfica influencia?

- H0 : As regiões não influenciam na inadimplencia
- H1 : As regiões inflenciam na inadimplencia

```{r}
geo_loan <- merge(account_loan, demograph, by.x = c("manager_id.y"), by.y = c("manager_id.x"))
novo_modelo <- glm(inadimplentes ~ payments, data = geo_loan)
summary(geo_loan)
```


## A idade do cliente influencia na inadimplencia?

## O QUE MAIS PODEMOS CRUZAR E VER SE INFLUENCIA NO MODELO DE PREVISAO DE INADIMPLENCIA??? DE OUTRAS TABELAS?????

```{r}
lapply( dbListConnections( dbDriver( drv = "MySQL")), dbDisconnect)
```











